---
import type { MarkdownHeading } from "astro";
import Prose from "../../components/prose.astro";
import { getCollection, render } from "astro:content";
import StoreLayout from "../../layouts/StoreLayout.astro";
import { format } from "date-fns";

export const prerender = true;


export async function getStaticPaths() {
    const articles = await getCollection("articles");
    
    return articles.map((article) => ({
        params: {
            slug: article.rendered?.metadata
                ? (
                      article.rendered.metadata
                          .headings as unknown as MarkdownHeading[]
                  )[0].slug
                : article.id,
        },
        props: { article },
    }));
}

const { article } = Astro.props;

if (article === undefined) {
    return new Response("Article not found", { status: 404 });
}

const { Content } = await render(article);

const allArticles = await getCollection("articles");

const relatedArticles = allArticles.filter(
    (relatedArticle) =>
        relatedArticle.data.category === article.data.category &&
        relatedArticle.id !== article.id,
);
---

<StoreLayout title={article.data.title} frontmatter={article.data}>
    <section class="px-4 py-8">
        <Prose>
            <Content />
        </Prose>

        <ul class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {
                relatedArticles.map((article) => (
                    <li>
                        <a href={`/blog/${article.rendered?.metadata ? (article.rendered.metadata.headings as unknown as MarkdownHeading[])[0].slug : article.id}`} >
                            <h2 class="text-base text-gray-900 font-medium">
                                {article.data.title}
                            </h2>
                            <p>{article.data.summary}</p>
                            <p class="text-sm text-gray-600">
                                {format(article.data.pubDate, "PPP")} &middot;{" "}
                                {article.data.author}
                            </p>
                        </a>
                    </li>
                ))
            }
        </ul>
    </section>
</StoreLayout>
